<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video to GIF Converter</title>
    <!-- Google Fonts: Inter for general text, IBM Plex Mono for code-like elements/accents -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=IBM+Plex+Mono:wght+400;500;600&display=swap" rel="stylesheet">

    <style>
        /* CSS Variables for a consistent, professional dark theme */
        :root {
            --font-primary: 'Inter', sans-serif;
            --font-mono: 'IBM Plex Mono', monospace;

            --color-bg-dark: #0F1626; /* Deep, muted blue-black */
            --color-bg-medium: #1F2C41; /* Slightly lighter, for main containers */
            --color-bg-light: #2A384F; /* For cards, offering contrast */
            --color-text-primary: #E0E7EB; /* Soft off-white */
            --color-text-secondary: #ABB8C3; /* Muted grey-blue */
            --color-accent: #00BFFF; /* A vibrant, professional sky blue */
            --color-accent-hover: #0099CC; /* Darker blue for hover */
            --color-border: rgba(255, 255, 255, 0.08); /* Very subtle border color */
            --shadow-color: rgba(0, 0, 0, 0.4); /* General shadow color */
        }

        /* Basic Reset & Font Smoothing */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth; /* Smooth scrolling for anchor links */
        }

        body {
            font-family: var(--font-primary);
            background-color: var(--color-bg-dark);
            color: var(--color-text-primary);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow: hidden; /* Prevent scroll */
            position: relative;
        }

        /* Subtle Radial Gradient on background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at center, rgba(0, 191, 255, 0.02) 0%, transparent 70%);
            z-index: -1;
            pointer-events: none;
        }

        .main-container {
            background-color: var(--color-bg-medium);
            border-radius: 12px;
            padding: 40px;
            box-shadow: 0 10px 30px var(--shadow-color);
            border: 1px solid var(--color-border);
            text-align: center;
            max-width: 600px; /* Adjusted for central UI */
            width: 90%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 30px;
            position: relative;
            z-index: 10; /* Ensure it's above background effects */
        }

        h1 {
            font-family: var(--font-mono);
            font-size: 2.5rem;
            color: var(--color-accent);
            margin-bottom: 20px;
            letter-spacing: 0.05em;
        }

        /* Settings Button */
        .settings-button {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            cursor: pointer;
            color: var(--color-text-secondary);
            transition: color 0.3s ease;
            padding: 10px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 48px;
            height: 48px;
        }

        .settings-button:hover {
            color: var(--color-accent);
            background-color: rgba(0, 191, 255, 0.1);
        }

        .settings-button svg {
            width: 30px;
            height: 30px;
            stroke: currentColor;
            stroke-width: 2;
        }

        /* Drag & Drop Zone */
        .drop-zone {
            width: 100%;
            min-height: 200px;
            border: 3px dashed var(--color-border);
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 20px;
            transition: all 0.3s ease;
            background-color: var(--color-bg-dark);
            cursor: pointer;
        }

        .drop-zone.drag-over {
            border-color: var(--color-accent);
            background-color: rgba(0, 191, 255, 0.1);
            transform: scale(1.02);
        }

        .drop-zone-icon {
            width: 60px;
            height: 60px;
            color: var(--color-text-secondary);
            margin-bottom: 15px;
        }
        .drop-zone-text {
            color: var(--color-text-secondary);
            font-size: 1.1rem;
        }
        .drop-zone-text strong {
            color: var(--color-accent);
        }

        input[type="file"] {
            display: none; /* Hide default file input */
        }

        /* Processing State */
        .processing-status {
            display: none; /* Hidden by default */
            width: 100%;
            background-color: var(--color-bg-dark);
            border-radius: 8px;
            padding: 25px;
            border: 1px solid var(--color-border);
            flex-direction: column;
            gap: 15px;
            text-align: left;
        }
        .processing-status.active {
            display: flex;
        }

        .status-message {
            font-size: 1.1rem;
            color: var(--color-text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-message .spinner {
            border: 4px solid rgba(0, 191, 255, 0.2);
            border-top: 4px solid var(--color-accent);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }

        .progress-bar-container {
            width: 100%;
            background-color: var(--color-border);
            border-radius: 5px;
            height: 15px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-bar {
            height: 100%;
            width: 0%;
            background-color: var(--color-accent);
            border-radius: 5px;
            transition: width 0.1s linear;
        }

        .timing-info {
            display: flex;
            justify-content: space-between;
            font-size: 0.95rem;
            color: var(--color-text-secondary);
            margin-top: 5px;
        }

        /* Completed State */
        .conversion-result {
            display: none; /* Hidden by default */
            width: 100%;
            background-color: var(--color-bg-dark);
            border-radius: 8px;
            padding: 25px;
            border: 1px solid var(--color-border);
            flex-direction: column;
            gap: 20px;
            align-items: center;
            text-align: center;
        }
        .conversion-result.active {
            display: flex;
        }

        .result-status {
            font-family: var(--font-mono);
            font-size: 1.8rem;
            color: var(--color-accent);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .result-status svg {
            color: #28a745; /* Green checkmark */
            width: 30px;
            height: 30px;
        }

        .result-preview {
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px;
            object-fit: contain;
            border: 1px solid var(--color-border);
        }

        .result-details {
            display: flex;
            flex-direction: column;
            gap: 8px;
            font-size: 0.95rem;
            color: var(--color-text-secondary);
        }
        .result-details span strong {
            color: var(--color-text-primary);
        }

        .download-button {
            display: inline-flex;
            align-items: center;
            padding: 12px 25px;
            background-color: var(--color-accent);
            color: var(--color-bg-dark);
            text-decoration: none;
            border-radius: 8px;
            font-family: var(--font-mono);
            font-size: 1rem;
            font-weight: 500;
            letter-spacing: 0.05em;
            box-shadow: 0 5px 15px rgba(0, 191, 255, 0.2);
            margin-top: 15px;
            transition: all 0.3s ease;
        }
        .download-button:hover {
            background-color: var(--color-accent-hover);
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 8px 20px rgba(0, 191, 255, 0.3);
        }
        .download-button svg {
            margin-right: 8px;
            width: 20px;
            height: 20px;
            stroke: var(--color-bg-dark);
        }

        .convert-another {
            margin-top: 15px;
            background: none;
            border: 1px solid var(--color-accent);
            color: var(--color-accent);
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-family: var(--font-mono);
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }
        .convert-another:hover {
            background-color: var(--color-accent);
            color: var(--color-bg-dark);
        }

        /* Settings Modal */
        .settings-modal-overlay {
            display: none; /* Hidden by default */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .settings-modal-overlay.active {
            display: flex;
        }

        .settings-modal-content {
            background-color: var(--color-bg-light);
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 15px 40px var(--shadow-color);
            border: 1px solid var(--color-border);
            max-width: 450px;
            width: 90%;
            text-align: left;
            position: relative;
        }

        .settings-modal-content h2 {
            font-family: var(--font-mono);
            font-size: 1.8rem;
            color: var(--color-accent);
            margin-bottom: 25px;
            border-bottom: 1px solid var(--color-border);
            padding-bottom: 10px;
        }

        .settings-modal-content .close-button {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 1.8rem;
            color: var(--color-text-secondary);
            cursor: pointer;
            transition: color 0.3s ease;
        }
        .settings-modal-content .close-button:hover {
            color: var(--color-accent);
        }

        .setting-item {
            margin-bottom: 20px;
        }
        .setting-item label {
            display: block;
            font-size: 1rem;
            color: var(--color-text-primary);
            margin-bottom: 8px;
            font-family: var(--font-mono);
        }
        .setting-item input[type="number"],
        .setting-item select {
            width: 100%;
            padding: 10px 15px;
            background-color: var(--color-bg-dark);
            border: 1px solid var(--color-border);
            border-radius: 6px;
            color: var(--color-text-primary);
            font-family: var(--font-primary);
            font-size: 1rem;
            appearance: none; /* Remove default select arrow */
            transition: border-color 0.3s ease;
        }
        .setting-item input[type="number"]:focus,
        .setting-item select:focus {
            outline: none;
            border-color: var(--color-accent);
        }

        .setting-item p.help-text {
            font-size: 0.85rem;
            color: var(--color-text-secondary);
            margin-top: 5px;
        }

        /* Utility classes */
        .hidden {
            display: none !important;
        }

        /* Keyframe Animations */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive Adjustments */
        @media (max-width: 768px) {
            .main-container {
                padding: 30px;
                gap: 20px;
            }
            h1 {
                font-size: 2rem;
            }
            .drop-zone {
                min-height: 150px;
            }
            .drop-zone-icon {
                width: 50px;
                height: 50px;
            }
            .drop-zone-text {
                font-size: 1rem;
            }
            .settings-button {
                width: 40px;
                height: 40px;
            }
            .settings-button svg {
                width: 24px;
                height: 24px;
            }
            .processing-status, .conversion-result {
                padding: 20px;
            }
            .result-status {
                font-size: 1.5rem;
            }
            .download-button {
                padding: 10px 20px;
                font-size: 0.95rem;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 15px;
            }
            .main-container {
                padding: 25px;
            }
            h1 {
                font-size: 1.8rem;
            }
            .drop-zone {
                min-height: 120px;
            }
            .drop-zone-icon {
                width: 40px;
                height: 40px;
            }
            .drop-zone-text {
                font-size: 0.9rem;
            }
            .settings-modal-content {
                padding: 25px;
            }
            .settings-modal-content h2 {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <h1>Video to GIF Converter</h1>

        <button class="settings-button" id="settings-button" aria-label="Settings">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-settings">
                <circle cx="12" cy="12" r="3"></circle>
                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0-.33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82-.33V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09A1.65 1.65 0 0 0 15 4.6a1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0 .33 1.82H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
            </svg>
        </button>

        <div class="drop-zone" id="drop-zone">
            <input type="file" id="file-input" accept="video/*">
            <svg class="drop-zone-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-upload-cloud">
                <polyline points="16 16 12 12 8 16"></polyline>
                <line x1="12" y1="12" x2="12" y2="21"></line>
                <path d="M20.39 18.39A5 5 0 0 0 18 9h-1.26A8 8 0 1 0 3 16.3"></path>
                <polyline points="16 16 12 12 8 16"></polyline>
            </svg>
            <p class="drop-zone-text">Drag & drop your video here, or <strong>click to select</strong></p>
        </div>

        <div class="processing-status hidden" id="processing-status">
            <p class="status-message" id="current-status">
                <span class="spinner"></span> Preparing converter...
            </p>
            <div class="progress-bar-container">
                <div class="progress-bar" id="progress-bar"></div>
            </div>
            <div class="timing-info">
                <span id="time-elapsed">Time Elapsed: 0s</span>
                <span id="time-remaining">Estimated Remaining: --</span>
            </div>
        </div>

        <div class="conversion-result hidden" id="conversion-result">
            <h2 class="result-status">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-check-circle">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-8.5"></path>
                    <polyline points="22 4 12 14.01 9 11.01"></polyline>
                </svg>
                Conversion Complete!
            </h2>
            <img src="" alt="Converted GIF" class="result-preview" id="gif-preview">
            <div class="result-details">
                <span>Original File: <strong><span id="original-file-name"></span> (<span id="original-file-size"></span>)</strong></span>
                <span>Output GIF Size: <strong><span id="output-file-size"></span></strong></span>
                <span>Conversion Duration: <strong><span id="conversion-duration"></span></strong></span>
            </div>
            <a href="#" download="converted.gif" class="download-button" id="download-button">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-download">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
                Download GIF
            </a>
            <button class="convert-another" id="convert-another">Convert Another Video</button>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="settings-modal-overlay" id="settings-modal-overlay">
        <div class="settings-modal-content">
            <button class="close-button" id="close-settings-button">×</button>
            <h2>Settings</h2>
            <div class="setting-item">
                <label for="gif-width">GIF Width (px):</label>
                <input type="number" id="gif-width" min="100" max="1920" value="480">
                <p class="help-text">Set the width of the output GIF. Height will be scaled automatically. (Default: 480px)</p>
            </div>
            <div class="setting-item">
                <label for="gif-fps">Frames Per Second (FPS):</label>
                <input type="number" id="gif-fps" min="1" max="60" value="10">
                <p class="help-text">Lower FPS reduces file size and quality. (Default: 10 FPS)</p>
            </div>
            <div class="setting-item">
                <label for="gif-quality">GIF Quality (Lower = Better):</label>
                <select id="gif-quality">
                    <option value="1">High (Larger file)</option>
                    <option value="5">Medium</option>
                    <option value="10" selected>Balanced (Default)</option>
                    <option value="20">Low (Smaller file)</option>
                </select>
                <p class="help-text">Controls the visual fidelity and color palette. This value maps to FFmpeg's `dither` and `colors` options.</p>
            </div>
        </div>
    </div>

    <!-- FFmpeg.wasm Library -->
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.9.7/dist/ffmpeg.min.js"></script>
    <script>
        const { createFFmpeg, fetchFile } = FFmpeg;
        // Point corePath to a CDN for GitHub Pages compatibility
        const ffmpeg = createFFmpeg({ log: false, corePath: 'https://unpkg.com/@ffmpeg/core@0.9.7/dist/ffmpeg-core.js' });

        // DOM Elements
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const processingStatus = document.getElementById('processing-status');
        const currentStatus = document.getElementById('current-status');
        const progressBar = document.getElementById('progress-bar');
        const timeElapsedSpan = document.getElementById('time-elapsed');
        const timeRemainingSpan = document.getElementById('time-remaining');
        const conversionResult = document.getElementById('conversion-result');
        const gifPreview = document.getElementById('gif-preview');
        const originalFileNameSpan = document.getElementById('original-file-name');
        const originalFileSizeSpan = document.getElementById('original-file-size');
        const outputFileSizeSpan = document.getElementById('output-file-size');
        const conversionDurationSpan = document.getElementById('conversion-duration');
        const downloadButton = document.getElementById('download-button');
        const convertAnotherButton = document.getElementById('convert-another');
        const settingsButton = document.getElementById('settings-button');
        const settingsModalOverlay = document.getElementById('settings-modal-overlay');
        const closeSettingsButton = document.getElementById('close-settings-button');

        // Settings elements
        const gifWidthInput = document.getElementById('gif-width');
        const gifFpsInput = document.getElementById('gif-fps');
        const gifQualitySelect = document.getElementById('gif-quality');

        let conversionStartTime = 0;
        let lastProgressTime = 0;
        let estimatedTimeTotal = 0;
        let currentFile = null;

        // --- Settings Management ---
        const defaultSettings = {
            width: 480,
            fps: 10,
            quality: '10' // This corresponds to a specific dither/colors setting
        };

        function loadSettings() {
            const savedSettings = JSON.parse(localStorage.getItem('gifConverterSettings')) || {};
            const settings = { ...defaultSettings, ...savedSettings };

            gifWidthInput.value = settings.width;
            gifFpsInput.value = settings.fps;
            gifQualitySelect.value = settings.quality;
        }

        function saveSettings() {
            const settings = {
                width: parseInt(gifWidthInput.value),
                fps: parseInt(gifFpsInput.value),
                quality: gifQualitySelect.value
            };
            localStorage.setItem('gifConverterSettings', JSON.stringify(settings));
        }

        function getConversionSettings() {
            return {
                width: parseInt(gifWidthInput.value),
                fps: parseInt(gifFpsInput.value),
                quality: gifQualitySelect.value
            };
        }

        // --- UI State Management ---
        function resetUI() {
            dropZone.classList.remove('hidden');
            processingStatus.classList.remove('active');
            conversionResult.classList.remove('active');
            currentStatus.innerHTML = '<span class="spinner"></span> Preparing converter...';
            progressBar.style.width = '0%';
            timeElapsedSpan.textContent = 'Time Elapsed: 0s';
            timeRemainingSpan.textContent = 'Estimated Remaining: --';
            if (gifPreview.src) URL.revokeObjectURL(gifPreview.src); // Clean up previous blob URL
            gifPreview.src = '';
            currentFile = null;
            settingsButton.classList.remove('hidden'); // Show settings button
        }

        function showProcessing(fileName, fileSize) {
            dropZone.classList.add('hidden');
            conversionResult.classList.add('hidden');
            processingStatus.classList.add('active');
            settingsButton.classList.add('hidden'); // Hide settings button during processing

            originalFileNameSpan.textContent = fileName;
            originalFileSizeSpan.textContent = formatBytes(fileSize);
            
            conversionStartTime = performance.now();
            lastProgressTime = conversionStartTime;
            estimatedTimeTotal = 0; // Reset
        }

        function updateProgress(message, ratio) {
            currentStatus.innerHTML = `<span class="spinner"></span> ${message}`;
            progressBar.style.width = `${ratio * 100}%`;

            const now = performance.now();
            const elapsed = (now - conversionStartTime) / 1000;
            timeElapsedSpan.textContent = `Time Elapsed: ${elapsed.toFixed(1)}s`;

            if (ratio > 0 && now - lastProgressTime > 500) { // Update estimated time more frequently
                lastProgressTime = now;
                // Simple estimate: total_time = elapsed / progress_ratio
                // This will be volatile early on, but stabilize.
                estimatedTimeTotal = elapsed / ratio;
                const remaining = estimatedTimeTotal - elapsed;
                timeRemainingSpan.textContent = `Estimated Remaining: ${Math.max(0, remaining).toFixed(1)}s`;
            } else if (ratio === 0) { // Reset estimated time at start
                timeRemainingSpan.textContent = `Estimated Remaining: --`;
            }
        }

        function showResult(gifUrl, gifSize, duration) {
            processingStatus.classList.remove('active');
            conversionResult.classList.add('active');
            gifPreview.src = gifUrl;
            outputFileSizeSpan.textContent = formatBytes(gifSize);
            conversionDurationSpan.textContent = `${duration.toFixed(1)}s`;
            settingsButton.classList.remove('hidden'); // Show settings button
        }

        function showError(message) {
            resetUI();
            alert(`Error: ${message}\n\nPlease try another file or adjust settings.`);
        }

        // --- Helper Functions ---
        function formatBytes(bytes, decimals = 2) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }

        async function loadFFmpegIfNecessary() {
            if (!ffmpeg.isLoaded()) {
                currentStatus.innerHTML = '<span class="spinner"></span> Loading converter core... (First time may take longer)';
                try {
                    await ffmpeg.load();
                    currentStatus.textContent = 'Converter loaded. Ready for conversion.';
                } catch (e) {
                    console.error("Failed to load converter:", e);
                    showError("Failed to load converter. Please check your internet connection.");
                    return false;
                }
            }
            return true;
        }

        // --- Event Handlers ---

        // Drag & Drop
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.add('drag-over');
            e.dataTransfer.dropEffect = 'copy';
        });

        dropZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.remove('drag-over');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.remove('drag-over');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                processFile(files[0]);
            }
        });

        // Click to select file
        dropZone.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                processFile(e.target.files[0]);
            }
        });

        async function processFile(file) {
            currentFile = file;
            if (!file.type.startsWith('video/')) {
                showError('Please drop a video file.');
                return;
            }

            resetUI();
            showProcessing(file.name, file.size);

            const loaded = await loadFFmpegIfNecessary();
            if (!loaded) return; // Stop if FFmpeg failed to load

            try {
                updateProgress('Reading video data...', 0);
                const data = await fetchFile(file);
                await ffmpeg.FS('writeFile', file.name, data);

                const settings = getConversionSettings();
                const outputFileName = 'output.gif';

                // Map quality setting to FFmpeg options for paletteuse
                // Dithering options: bayer, floyd_steinberg, sierra2_4a, sierra2_2a, none
                // colors: number of colors in the palette (max 256 for GIF)
                let ditherOption = 'sierra2_4a'; // Good general-purpose dither
                let colorsOption = 128; // Default, balanced
                switch(settings.quality) {
                    case '1': ditherOption = 'bayer:bayer_scale=0'; colorsOption = 256; break; // Highest quality, max colors
                    case '5': ditherOption = 'sierra2_4a'; colorsOption = 200; break; // Good balance
                    case '10': ditherOption = 'sierra2_4a'; colorsOption = 128; break; // Default, good compromise
                    case '20': ditherOption = 'sierra2_2a'; colorsOption = 64; break; // Lower quality, fewer colors
                }

                // Complex filter for palettegen and paletteuse for better GIF quality
                const filters = [
                    `fps=${settings.fps}`,
                    `scale=${settings.width}:-1:flags=lanczos` // lanczos for high quality scaling
                ].join(',');

                // Pass 1: Generate palette
                const palettegenCommand = [
                    '-i', file.name,
                    '-vf', `${filters},palettegen=stats_mode=diff`, // diff mode for animations
                    '-y', 'palette.png' // Output palette image
                ];

                // Pass 2: Use palette to generate GIF
                const paletteuseCommand = [
                    '-i', file.name,
                    '-i', 'palette.png', // Input palette
                    '-lavfi', `${filters}[x];[x][1:v]paletteuse=dither=${ditherOption}:colors=${colorsOption}`,
                    '-y', outputFileName
                ];

                // Monitor progress
                ffmpeg.setProgress(({ ratio }) => {
                    // Ratio from 0 to 1, spread across both passes roughly 50/50
                    let overallRatio = ratio / 2; // For palettegen
                    if (ffmpeg.currentCommand === paletteuseCommand.join(' ')) {
                        overallRatio = 0.5 + (ratio / 2); // For paletteuse
                    }
                    updateProgress('Converting video...', overallRatio);
                });

                updateProgress('Generating GIF palette (Pass 1/2)...', 0.1);
                await ffmpeg.run(...palettegenCommand);

                updateProgress('Generating GIF (Pass 2/2)...', 0.5);
                await ffmpeg.run(...paletteuseCommand);

                const outputData = ffmpeg.FS('readFile', outputFileName);
                const gifBlob = new Blob([outputData.buffer], { type: 'image/gif' });
                const gifUrl = URL.createObjectURL(gifBlob);

                const conversionEndtime = performance.now();
                const durationSeconds = (conversionEndtime - conversionStartTime) / 1000;

                showResult(gifUrl, gifBlob.size, durationSeconds);
                downloadButton.href = gifUrl;
                downloadButton.download = `${file.name.split('.')[0] || 'converted'}.gif`;

            } catch (error) {
                console.error("Conversion error:", error);
                showError(`Conversion failed: ${error.message || 'An unknown error occurred.'}`);
            } finally {
                // Clean up files from FFmpeg's virtual filesystem
                if (file) {
                    try {
                        await ffmpeg.FS('unlink', file.name);
                    } catch (e) { /* ignore if already gone */ }
                }
                try {
                    await ffmpeg.FS('unlink', 'palette.png');
                    await ffmpeg.FS('unlink', 'output.gif');
                } catch (e) { /* ignore if not created or already gone */ }
            }
        }

        // Convert Another button
        convertAnotherButton.addEventListener('click', () => {
            resetUI();
            fileInput.value = ''; // Clear file input
        });

        // Settings Modal Handlers
        settingsButton.addEventListener('click', () => {
            settingsModalOverlay.classList.add('active');
        });

        closeSettingsButton.addEventListener('click', () => {
            settingsModalOverlay.classList.remove('active');
            saveSettings(); // Save settings when modal is closed
        });

        settingsModalOverlay.addEventListener('click', (e) => {
            if (e.target === settingsModalOverlay) {
                settingsModalOverlay.classList.remove('active');
                saveSettings(); // Save settings when clicking outside
            }
        });

        // Initial setup on DOMContentLoaded
        document.addEventListener('DOMContentLoaded', () => {
            loadSettings(); // Load settings when page loads
            resetUI(); // Ensure UI is in default state
            // Pre-loading FFmpeg here for faster first conversion, but hide status until file is dropped
            loadFFmpegIfNecessary();
        });
    </script>
</body>
</html>
